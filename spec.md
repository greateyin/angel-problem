## 天使問題遊戲規格（重寫版）

本文件描述一個以 Next.js / React Hooks 實作的「天使 vs 惡魔」遊戲。核心目標：支援人類/AI 混合對戰、清晰的回合流程，以及可視化棋盤互動。

### 遊戲規則（符合 Conway 精神）
- 棋盤：無限整數方格，UI 只呈現中心視窗，不限制邏輯座標。
- 惡魔：每回合可封鎖任意一格（不可是天使當前格），封鎖後永久不可用。
- 天使：力量 `K`，每回合可移動到 Chebyshev 距離 ≤ K 的任一未封鎖格（可斜走，忽略途經格）。
- 先後手：惡魔先、天使後，循環往復。
- 勝負：天使在自己回合若沒有可行移動，惡魔勝；若能無限持續則天使可存活。

### 可配置變數
- `K` 初始值：預設 2，可由輸入框動態調整；上限預設 10，可依需求提高（甚至放寬為任意正整數）。
- 棋盤視窗 `BOARD_SIZE`：預設 11（呈現 11×11 中心截圖），可放大以觀察大步長或更遠距離。
- AI 延遲：預設 500ms，可調整以改變自動回合節奏。
- 模式預設：預設 `human_vs_human`，可改為其他模式作為初始值。

### 遊戲規則
- 棋盤：無限方格，UI 以中心截圖顯示（預設 11×11）。
- 天使力量 `K`：整數，表示單回合最多可移動的步數（含斜向，最多 K 格）。
- 回合順序：惡魔先放置 1 個路障 → 天使移動 → 重複循環。
- 勝負：若天使在其回合沒有任何可行移動，惡魔勝；若遊戲能無限繼續，視為天使可存活。

### 對戰模式
- `human_vs_human`：雙方皆人類操作。
- `human_vs_ai`：惡魔人類、天使 AI。
- `ai_vs_human`：惡魔 AI、天使人類。
- `ai_vs_ai`：雙方 AI（觀戰）。

### AI 策略（簡易版）
- 惡魔 AI：在天使周圍 `K+1` 範圍內隨機挑選一個空格放置路障（避開天使位置與既有路障）。
- 天使 AI：在可行移動集合中，挑選「距離最近路障最遠」的格子；若無路障則任選可行移動。

### 狀態與資料結構
- `K`：天使力量。
- `angelPos: {x, y}`：天使當前座標；`posToKey(pos) => "x,y"`；`keyToPos(key) => {x, y}`。
- `roadblocks: Set<string>`：路障位置集合。
- `turn: 'demon' | 'angel' | 'game_over'`：回合狀態。
- `mode`：對戰模式（上節列舉）。
- `message`：當前提示文字。
- `isGameActive: boolean`：遊戲是否仍進行。
- `possibleMoves`：由 `getPossibleMoves(angelPos, K, roadblocks)` 計算；範圍為 `(2K+1)×(2K+1)`，排除路障與原地。

### 回合流程
1) 惡魔回合：
   - 人類：點擊空格放置路障，非法位置顯示訊息。
   - AI：延遲 500ms 後自動選位；若找不到空格，顯示錯誤訊息。
   - 完成後切換 `turn = 'angel'`。
2) 天使回合：
   - 檢查 `possibleMoves` 是否為空；若空則設定 `turn = 'game_over'` 並顯示惡魔勝。
   - 人類：點擊可行移動格移動。
   - AI：延遲 500ms 後依策略選點。
   - 完成後切換 `turn = 'demon'`。

### 演算法細節
- 可行移動計算：
  - 以 `(2K+1)×(2K+1)` 視窗掃描天使周圍；排除原地；排除 `roadblocks`；保留其餘座標為 `possibleMoves`（Chebyshev 距離判準）。
- 惡魔動作（共用 handler）：
  - 驗證回合；檢查是否是天使位置或已有路障；合法則加入 `roadblocks` 並切換回合。
- 天使動作（共用 handler）：
  - 若 `possibleMoves` 為空即結束遊戲；
  - 否則檢查目標是否在 `possibleMoves`；合法則更新位置並切換回合；非法則提示原因。
- AI 執行：
  - 依模式決定是否由 AI 呼叫相同 handler；延遲 `AI 延遲` 毫秒後選點並執行；若選點失敗則提示並停留回合。

### UI 要求
- 棋盤渲染：以中心為基準的固定視窗；格子標示天使、路障、可行移動。
- 控制面板：
  - 模式切換按鈕（禁用非當前或遊戲已結束時的切換）。
  - `K` 輸入框（數字，可在遊戲中調整；上限可配置）。
  - 當前回合與模式文字提示。
  - 訊息區（依回合高亮顏色）。
  - 重新開始按鈕（可直接重整或重置狀態）。
- 互動限制：當回合為 AI 時，阻止人類操作；遊戲結束後禁用操作。

### 样式指引（保持簡潔，可用內聯或樣式表）
- 棋盤格：40px 正方形、細框、hover/可行移動用淡綠色底、天使用淡黃、路障用淡紅。
- 文字：預設系統無襯線字體即可。

### 主要函式（範例參考）
- `getPossibleMoves(angelPos, K, roadblocks)`：回傳可行移動座標陣列。
- `makeDemonMoveAI(angelPos, K, roadblocks)`：回傳惡魔 AI 選擇的座標或 `null`。
- `makeAngelMoveAI(possibleMoves, roadblocks)`：回傳天使 AI 選擇的座標或 `null`。
- `handlePlaceRoadblock(x, y, isAI)` / `handleMoveAngel(x, y, isAI)`：統一處理 AI 與人類操作，負責檢查合法性、更新狀態、切換回合與訊息。

### 邊界條件與提示
- 避免將路障放在天使所在位置或重複位置。
- `possibleMoves` 為空時立即宣告惡魔勝。
- 若 AI 找不到可放置/可移動位置，提示並停留原回合以利調試。

### 待辦/擴充建議
- 加入更強的 AI（如 BFS/啟發式搜尋）。
- 棋盤視窗可縮放或拖曳查看更大範圍。
- 加入行為記錄/回放、撤銷一步等功能。
